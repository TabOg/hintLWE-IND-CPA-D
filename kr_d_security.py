# this code corresponds to Section 6.3
from sage.all import log, e, sqrt
from ind_cpa_d_security import worst_case_ATA, sigma_i
from hintLWE_security import hint_lwe_search_normalised_noise_flooding

def bit_security_flooding_noise(t, logE, original_security, target_security):
    l = original_security - target_security
    assert(l >= 1)
    loss = original_security - target_security
    total_flooding_noise = log(2 * original_security * t * log(e, 2), 2) / 2 + logE - log(l, 2)
    return total_flooding_noise.n()


def hint_lwe_flooding_noise(t, rescaled_noise_bound, hintlwe_security, target_security, n, log_normalised_flooding_stddev):
    ATA_bound = worst_case_ATA(n)
    sigma_i_ = sigma_i(t, ATA_bound, log_normalised_flooding_stddev)
    
    rescaled_noise_flooding = bit_security_flooding_noise(t, rescaled_noise_bound, hintlwe_security, target_security)
    
    return max(rescaled_noise_flooding, sigma_i_)

def flooding_noise_levels(parameters, t, original_security, target_security, max_rescaled_noise_magnitude=40):
    (logn, logq, sigma_s, sigma_e) = parameters
    n = 2 ** logn
    
    # since our results are in terms of |error|_2, we convert this to addition precision loss via sqrt(n) * sigma / |error|_2
    additional_precision_loss = lambda logn, log_sigma, log_total_noise: (logn / 2 + log_sigma - log_total_noise).n()
    
    absolute_noise = {"bit_security": [], "hint_lwe": []}
    
    additional_noise = {"bit_security": [], "hint_lwe": []}
    
    # a (2 norm) bound on the noise due to rescaling, ([A]_q * s - [b]_q ) / q
    rescaling_noise = (sqrt(worst_case_ATA(n)) * sqrt(n) * sigma_s + 0.5).n()
    
    cross_over_point = log(rescaling_noise, 2).n()
    
    # this is the security we target for HintLWE (Search)
    kappa_prime = target_security + 1
    print(f"targetting hintLWE security = {kappa_prime}")
    
    try:
        [(_, log_normalised_flooding_stddev)] = hint_lwe_search_normalised_noise_flooding([parameters], kappa_prime)
    except:
        ValueError(f"cannot achieve {target_security=} via reduction: try increasing secret variance or decreasing target security")
        return cross_over_point, absolute_noise, additional_noise
    
    for rescaled_noise_magnitude in range(1, max_rescaled_noise_magnitude + 1):
        # first we calculate a bound on the total noise from the bound on the rescaled noise magnitude. All in 2 norm
        total_noise = 2 ** rescaled_noise_magnitude + rescaling_noise
        log_total_noise = log(total_noise, 2)
        
        bit_security_flooding_noise_ = bit_security_flooding_noise(t, log_total_noise, original_security, target_security)
        absolute_noise["bit_security"].append((rescaled_noise_magnitude, bit_security_flooding_noise_))
        bit_security_precision_loss = additional_precision_loss(logn, bit_security_flooding_noise_, log_total_noise)
        additional_noise["bit_security"].append((rescaled_noise_magnitude, bit_security_precision_loss))
        
        hint_lwe_flooding_noise_ = hint_lwe_flooding_noise(t, rescaled_noise_magnitude, kappa_prime, target_security, n, log_normalised_flooding_stddev)
        absolute_noise["hint_lwe"].append((rescaled_noise_magnitude, hint_lwe_flooding_noise_.n()))
        hint_lwe_precision_loss = additional_precision_loss(logn, hint_lwe_flooding_noise_, log_total_noise)
        additional_noise["hint_lwe"].append((rescaled_noise_magnitude, hint_lwe_precision_loss.n()))
    
    return cross_over_point, absolute_noise, additional_noise
        
if __name__ == "__main__":
    # this script generates the data for Fig 4
    target_security = 120
    t = 2 ** 6
    
    parameter_sets = [
        (10, 28, 3.19, 3.19),
        (12, 108, 3.19, 3.19),
        (14, 432, 3.19, 3.19),
        (16, 1749, 3.19, 3.19)
        ]
    original_security_levels = [
        131.903812370381,
        128.934036200343,
        128.334392294043,
        128.021734664213
        ]
    
    for parameters, original_security in zip(parameter_sets, original_security_levels):
        print(f"# {parameters=}")
        cross_over_point, absolute_noise, additional_noise = flooding_noise_levels(parameters, t, original_security, target_security)
        print(f"# cross over point (rescaling noise = rescaled noise) at {cross_over_point}")
        
        print("# absolute noise:")
        for key in absolute_noise.keys():
            print(f"#\t{key} = ", absolute_noise[key])
            print()
        print()
        print("# additional noise:")
        for key in additional_noise.keys():
            print(f"#\t{key} = ", additional_noise[key])
            print()

# parameters=(10, 28, 3.19, 3.19)
# cross over point (rescaling noise = rescaled noise) at 16.0220728317263
# absolute noise:
#       bit_security =  [(1, 19.7348188163088), (2, 19.7348621734303), (3, 19.7349488837644), (4, 19.7351222887997), (5, 19.7354690363554), (6, 19.7361622815475), (7, 19.7375477733750), (8, 19.7403147717373), (9, 19.7458328983873), (10, 19.7568062340779), (11, 19.7785056415989), (12, 19.8209492036462), (13, 19.9022645333966), (14, 20.0523159204323), (15, 20.3124178071289), (16, 20.7237812551304), (17, 21.3050603241273), (18, 22.0390723867337), (19, 22.8850969076884), (20, 23.8014732597861), (21, 24.7577706047919), (22, 25.7354125916912), (23, 26.7241022941487), (24, 27.7184137196441), (25, 28.7155609989112), (26, 29.7141325204366), (27, 30.7134177504481), (28, 31.7130602326127), (29, 32.7128814404655), (30, 33.7127920360821), (31, 34.7127473318126), (32, 35.7127249791584), (33, 36.7127138027015), (34, 37.7127082144405), (35, 38.7127054203019), (36, 39.7127040232306), (37, 40.7127033246944), (38, 41.7127029754262), (39, 42.7127028007921), (40, 43.7127027134750)]

#       hint_lwe =  [(1, 12.9255051764601), (2, 12.9255051764601), (3, 12.9255051764601), (4, 12.9255051764601), (5, 12.9255051764601), (6, 13.2238148051097), (7, 14.2238148051097), (8, 15.2238148051097), (9, 16.2238148051097), (10, 17.2238148051097), (11, 18.2238148051097), (12, 19.2238148051097), (13, 20.2238148051097), (14, 21.2238148051097), (15, 22.2238148051097), (16, 23.2238148051097), (17, 24.2238148051097), (18, 25.2238148051097), (19, 26.2238148051097), (20, 27.2238148051097), (21, 28.2238148051097), (22, 29.2238148051097), (23, 30.2238148051097), (24, 31.2238148051097), (25, 32.2238148051097), (26, 33.2238148051097), (27, 34.2238148051097), (28, 35.2238148051097), (29, 36.2238148051097), (30, 37.2238148051097), (31, 38.2238148051097), (32, 39.2238148051097), (33, 40.2238148051097), (34, 41.2238148051097), (35, 42.2238148051097), (36, 43.2238148051097), (37, 44.2238148051097), (38, 45.2238148051097), (39, 46.2238148051097), (40, 47.2238148051097)]


# additional noise:
#       bit_security =  [(1, 8.71270262615791), (2, 8.71270262615791), (3, 8.71270262615791), (4, 8.71270262615791), (5, 8.71270262615791), (6, 8.71270262615791), (7, 8.71270262615791), (8, 8.71270262615791), (9, 8.71270262615791), (10, 8.71270262615791), (11, 8.71270262615791), (12, 8.71270262615791), (13, 8.71270262615791), (14, 8.71270262615791), (15, 8.71270262615791), (16, 8.71270262615791), (17, 8.71270262615791), (18, 8.71270262615791), (19, 8.71270262615791), (20, 8.71270262615791), (21, 8.71270262615791), (22, 8.71270262615791), (23, 8.71270262615791), (24, 8.71270262615791), (25, 8.71270262615790), (26, 8.71270262615791), (27, 8.71270262615790), (28, 8.71270262615791), (29, 8.71270262615790), (30, 8.71270262615791), (31, 8.71270262615790), (32, 8.71270262615791), (33, 8.71270262615791), (34, 8.71270262615791), (35, 8.71270262615791), (36, 8.71270262615791), (37, 8.71270262615791), (38, 8.71270262615791), (39, 8.71270262615791), (40, 8.71270262615791)]

#       hint_lwe =  [(1, 1.90338898630928), (2, 1.90334562918778), (3, 1.90325891885360), (4, 1.90308551381835), (5, 1.90273876626267), (6, 2.20035514972014), (7, 3.19896965789269), (8, 4.19620265953035), (9, 5.19068453288032), (10, 6.17971119718975), (11, 7.15801178966874), (12, 8.11556822762142), (13, 9.03425289787101), (14, 9.88420151083532), (15, 10.6240996241388), (16, 11.2127361761372), (17, 11.6314571071404), (18, 11.8974450445340), (19, 12.0514205235793), (20, 12.1350441714815), (21, 12.1787468264757), (22, 12.2011048395765), (23, 12.2124151371190), (24, 12.2181037116236), (25, 12.2209564323564), (26, 12.2223849108311), (27, 12.2230996808195), (28, 12.2234571986550), (29, 12.2236359908022), (30, 12.2237253951856), (31, 12.2237700994550), (32, 12.2237924521092), (33, 12.2238036285662), (34, 12.2238092168271), (35, 12.2238120109657), (36, 12.2238134080371), (37, 12.2238141065732), (38, 12.2238144558414), (39, 12.2238146304756), (40, 12.2238147177927)]

# parameters=(12, 108, 3.19, 3.19)
# cross over point (rescaling noise = rescaled noise) at 19.0220617555875
# absolute noise:
#       bit_security =  [(1, 23.1323829358590), (2, 23.1323883557546), (3, 23.1323991954847), (4, 23.1324208747005), (5, 23.1324642321549), (6, 23.1325509431547), (7, 23.1327243495210), (8, 23.1330710997379), (9, 23.1337643502485), (10, 23.1351498526976), (11, 23.1379168722423), (12, 23.1434350410144), (13, 23.1544084599915), (14, 23.1761080303556), (15, 23.2185519039261), (16, 23.2998678055041), (17, 23.4499201667362), (18, 23.7100235196818), (19, 24.1213888089047), (20, 24.7026697285345), (21, 25.4366832784720), (22, 26.2827087943714), (23, 27.1990857330031), (24, 28.1553833983347), (25, 29.1330255529012), (26, 30.1217153411718), (27, 31.1160268100822), (28, 32.1131741111858), (29, 33.1117456436618), (30, 34.1110308791568), (31, 35.1106733640652), (32, 36.1104945732904), (33, 37.1104051695933), (34, 38.1103604656670), (35, 39.1103381131845), (36, 40.1103269368133), (37, 41.1103213485952), (38, 42.1103185544781), (39, 43.1103171574175), (40, 44.1103164588867)]

#       hint_lwe =  [(1, 15.0089876173764), (2, 15.0089876173764), (3, 15.0089876173764), (4, 15.0089876173764), (5, 15.0089876173764), (6, 15.0089876173764), (7, 15.0089876173764), (8, 15.2238148051097), (9, 16.2238148051097), (10, 17.2238148051097), (11, 18.2238148051097), (12, 19.2238148051097), (13, 20.2238148051097), (14, 21.2238148051097), (15, 22.2238148051097), (16, 23.2238148051097), (17, 24.2238148051097), (18, 25.2238148051097), (19, 26.2238148051097), (20, 27.2238148051097), (21, 28.2238148051097), (22, 29.2238148051097), (23, 30.2238148051097), (24, 31.2238148051097), (25, 32.2238148051097), (26, 33.2238148051097), (27, 34.2238148051097), (28, 35.2238148051097), (29, 36.2238148051097), (30, 37.2238148051097), (31, 38.2238148051097), (32, 39.2238148051097), (33, 40.2238148051097), (34, 41.2238148051097), (35, 42.2238148051097), (36, 43.2238148051097), (37, 44.2238148051097), (38, 45.2238148051097), (39, 46.2238148051097), (40, 47.2238148051097)]


# additional noise:
#       bit_security =  [(1, 10.1103157603556), (2, 10.1103157603556), (3, 10.1103157603556), (4, 10.1103157603556), (5, 10.1103157603556), (6, 10.1103157603556), (7, 10.1103157603556), (8, 10.1103157603556), (9, 10.1103157603556), (10, 10.1103157603556), (11, 10.1103157603556), (12, 10.1103157603556), (13, 10.1103157603556), (14, 10.1103157603556), (15, 10.1103157603556), (16, 10.1103157603556), (17, 10.1103157603556), (18, 10.1103157603556), (19, 10.1103157603556), (20, 10.1103157603556), (21, 10.1103157603556), (22, 10.1103157603556), (23, 10.1103157603556), (24, 10.1103157603556), (25, 10.1103157603556), (26, 10.1103157603556), (27, 10.1103157603556), (28, 10.1103157603555), (29, 10.1103157603555), (30, 10.1103157603555), (31, 10.1103157603555), (32, 10.1103157603555), (33, 10.1103157603555), (34, 10.1103157603555), (35, 10.1103157603555), (36, 10.1103157603555), (37, 10.1103157603555), (38, 10.1103157603555), (39, 10.1103157603555), (40, 10.1103157603555)]

#       hint_lwe =  [(1, 1.98692044187292), (2, 1.98691502197734), (3, 1.98690418224727), (4, 1.98688250303145), (5, 1.98683914557709), (6, 1.98675243457726), (7, 1.98657902821094), (8, 2.20105946572745), (9, 3.20036621521679), (10, 4.19898071276766), (11, 5.19621369322300), (12, 6.19069552445094), (13, 7.17972210547380), (14, 8.15802253510968), (15, 9.11557866153918), (16, 10.0342627599612), (17, 10.8842103987291), (18, 11.6241070457835), (19, 12.2127417565606), (20, 12.6314608369308), (21, 12.8974472869933), (22, 13.0514217710939), (23, 13.1350448324622), (24, 13.1787471671306), (25, 13.2011050125641), (26, 13.2124152242935), (27, 13.2181037553831), (28, 13.2209564542795), (29, 13.2223849218035), (30, 13.2230996863085), (31, 13.2234572014001), (32, 13.2236359921749), (33, 13.2237253958720), (34, 13.2237700997982), (35, 13.2237924522808), (36, 13.2238036286520), (37, 13.2238092168701), (38, 13.2238120109872), (39, 13.2238134080478), (40, 13.2238141065786)]

# parameters=(14, 432, 3.19, 3.19)
# cross over point (rescaling noise = rescaled noise) at 22.0220604705212
# absolute noise:
#       bit_security =  [(1, 26.2292493459024), (2, 26.2292500233933), (3, 26.2292513783741), (4, 26.2292540883319), (5, 26.2292595082323), (6, 26.2292703479721), (7, 26.2292920272072), (8, 26.2293353847002), (9, 26.2294220957772), (10, 26.2295955022980), (11, 26.2299422528236), (12, 26.2306355039513), (13, 26.2320210076328), (14, 26.2347880296350), (15, 26.2403062032942), (16, 26.2512796319343), (17, 26.2729792211918), (18, 26.3154231309057), (19, 26.3967390988280), (20, 26.5467915730879), (21, 26.8068950961496), (22, 27.2182605989934), (23, 27.7995417333356), (24, 28.5335554558347), (25, 29.3795810871683), (26, 30.2959580938501), (27, 31.2522557963462), (28, 32.2298979703656), (29, 33.2185877685922), (30, 34.2128992425397), (31, 35.2100465461767), (32, 36.2086180799232), (33, 37.2079033160545), (34, 38.2075458012811), (35, 39.2073670106655), (36, 40.2072776070481), (37, 41.2072329031617), (38, 42.2072105506990), (39, 43.2071993743378), (40, 44.2071937861247)]

#       hint_lwe =  [(1, 17.1237360157773), (2, 17.1237360157773), (3, 17.1237360157773), (4, 17.1237360157773), (5, 17.1237360157773), (6, 17.1237360157773), (7, 17.1237360157773), (8, 17.1237360157773), (9, 17.1237360157773), (10, 17.2238148051097), (11, 18.2238148051097), (12, 19.2238148051097), (13, 20.2238148051097), (14, 21.2238148051097), (15, 22.2238148051097), (16, 23.2238148051097), (17, 24.2238148051097), (18, 25.2238148051097), (19, 26.2238148051097), (20, 27.2238148051097), (21, 28.2238148051097), (22, 29.2238148051097), (23, 30.2238148051097), (24, 31.2238148051097), (25, 32.2238148051097), (26, 33.2238148051097), (27, 34.2238148051097), (28, 35.2238148051097), (29, 36.2238148051097), (30, 37.2238148051097), (31, 38.2238148051097), (32, 39.2238148051097), (33, 40.2238148051097), (34, 41.2238148051097), (35, 42.2238148051097), (36, 43.2238148051097), (37, 44.2238148051097), (38, 45.2238148051097), (39, 46.2238148051097), (40, 47.2238148051097)]


# additional noise:
#       bit_security =  [(1, 11.2071881978900), (2, 11.2071881978900), (3, 11.2071881978900), (4, 11.2071881978900), (5, 11.2071881978900), (6, 11.2071881978900), (7, 11.2071881978900), (8, 11.2071881978900), (9, 11.2071881978900), (10, 11.2071881978900), (11, 11.2071881978900), (12, 11.2071881978900), (13, 11.2071881978900), (14, 11.2071881978900), (15, 11.2071881978900), (16, 11.2071881978900), (17, 11.2071881978900), (18, 11.2071881978900), (19, 11.2071881978900), (20, 11.2071881978900), (21, 11.2071881978900), (22, 11.2071881978900), (23, 11.2071881978900), (24, 11.2071881978900), (25, 11.2071881978900), (26, 11.2071881978900), (27, 11.2071881978900), (28, 11.2071881978900), (29, 11.2071881978900), (30, 11.2071881978900), (31, 11.2071881978900), (32, 11.2071881978900), (33, 11.2071881978900), (34, 11.2071881978900), (35, 11.2071881978900), (36, 11.2071881978900), (37, 11.2071881978900), (38, 11.2071881978900), (39, 11.2071881978900), (40, 11.2071881978900)]

#       hint_lwe =  [(1, 2.10167486776490), (2, 2.10167419027401), (3, 2.10167283529318), (4, 2.10167012533534), (5, 2.10166470543493), (6, 2.10165386569520), (7, 2.10163218646007), (8, 2.10158882896710), (9, 2.10150211789004), (10, 2.20140750070177), (11, 3.20106075017618), (12, 4.20036749904845), (13, 5.19898199536698), (14, 6.19621497336471), (15, 7.19069679970558), (16, 8.17972337106541), (17, 9.15802378180796), (18, 10.1155798720940), (19, 11.0342639041717), (20, 11.8842114299119), (21, 12.6241079068501), (22, 13.2127424040064), (23, 13.6314612696642), (24, 13.8974475471651), (25, 14.0514219158315), (26, 14.1350449091497), (27, 14.1787472066536), (28, 14.2011050326342), (29, 14.2124152344076), (30, 14.2181037604601), (31, 14.2209564568230), (32, 14.2223849230765), (33, 14.2230996869453), (34, 14.2234572017186), (35, 14.2236359923342), (36, 14.2237253959516), (37, 14.2237700998381), (38, 14.2237924523007), (39, 14.2238036286620), (40, 14.2238092168750)]

# parameters=(16, 1749, 3.19, 3.19)
# cross over point (rescaling noise = rescaled noise) at 25.0220603161038
# absolute noise:
#       bit_security =  [(1, 29.2826518164013), (2, 29.2826519010877), (3, 29.2826520704605), (4, 29.2826524092061), (5, 29.2826530866971), (6, 29.2826544416780), (7, 29.2826571516362), (8, 29.2826625715372), (9, 29.2826734112781), (10, 29.2826950905155), (11, 29.2827384480131), (12, 29.2828251590995), (13, 29.2829985656388), (14, 29.2833453162015), (15, 29.2840385674033), (16, 29.2854240712329), (17, 29.2881910935305), (18, 29.2937092677768), (19, 29.3046826975782), (20, 29.3263822891059), (21, 29.3688262031629), (22, 29.4501421790573), (23, 29.6001946668989), (24, 29.8602982104024), (25, 30.2716637389154), (26, 30.8529448990581), (27, 31.5869586422927), (28, 32.4329842874972), (29, 33.3493613023561), (30, 34.3056590093179), (31, 35.2833011856749), (32, 36.2719909850978), (33, 37.2663024596506), (34, 38.2634497635921), (35, 39.2620212974912), (36, 40.2613065336989), (37, 41.2609490189639), (38, 42.2607702283674), (39, 43.2606808247595), (40, 44.2606361208779)]

#       hint_lwe =  [(1, 19.2338568391687), (2, 19.2338568391687), (3, 19.2338568391687), (4, 19.2338568391687), (5, 19.2338568391687), (6, 19.2338568391687), (7, 19.2338568391687), (8, 19.2338568391687), (9, 19.2338568391687), (10, 19.2338568391687), (11, 19.2338568391687), (12, 19.2338568391687), (13, 20.2238148051097), (14, 21.2238148051097), (15, 22.2238148051097), (16, 23.2238148051097), (17, 24.2238148051097), (18, 25.2238148051097), (19, 26.2238148051097), (20, 27.2238148051097), (21, 28.2238148051097), (22, 29.2238148051097), (23, 30.2238148051097), (24, 31.2238148051097), (25, 32.2238148051097), (26, 33.2238148051097), (27, 34.2238148051097), (28, 35.2238148051097), (29, 36.2238148051097), (30, 37.2238148051097), (31, 38.2238148051097), (32, 39.2238148051097), (33, 40.2238148051097), (34, 41.2238148051097), (35, 42.2238148051097), (36, 43.2238148051097), (37, 44.2238148051097), (38, 45.2238148051097), (39, 46.2238148051097), (40, 47.2238148051097)]


# additional noise:
#       bit_security =  [(1, 12.2605914156110), (2, 12.2605914156110), (3, 12.2605914156110), (4, 12.2605914156110), (5, 12.2605914156110), (6, 12.2605914156110), (7, 12.2605914156110), (8, 12.2605914156110), (9, 12.2605914156110), (10, 12.2605914156110), (11, 12.2605914156110), (12, 12.2605914156110), (13, 12.2605914156110), (14, 12.2605914156110), (15, 12.2605914156110), (16, 12.2605914156110), (17, 12.2605914156110), (18, 12.2605914156110), (19, 12.2605914156110), (20, 12.2605914156110), (21, 12.2605914156110), (22, 12.2605914156110), (23, 12.2605914156110), (24, 12.2605914156110), (25, 12.2605914156110), (26, 12.2605914156110), (27, 12.2605914156110), (28, 12.2605914156110), (29, 12.2605914156110), (30, 12.2605914156110), (31, 12.2605914156110), (32, 12.2605914156110), (33, 12.2605914156110), (34, 12.2605914156110), (35, 12.2605914156110), (36, 12.2605914156110), (37, 12.2605914156110), (38, 12.2605914156110), (39, 12.2605914156110), (40, 12.2605914156110)]

#       hint_lwe =  [(1, 2.21179643837844), (2, 2.21179635369202), (3, 2.21179618431919), (4, 2.21179584557359), (5, 2.21179516808262), (6, 2.21179381310165), (7, 2.21179110314352), (8, 2.21178568324253), (9, 2.21177484350164), (10, 2.21175316426419), (11, 2.21170980676657), (12, 2.21162309568023), (13, 3.20140765508197), (14, 4.20106090451927), (15, 5.20036765331740), (16, 6.19898214948784), (17, 7.19621512719026), (18, 8.19069695294388), (19, 9.17972352314257), (20, 10.1580239316148), (21, 11.1155800175578), (22, 12.0342640416634), (23, 12.8842115538218), (24, 13.6241080103183), (25, 14.2127424818053), (26, 14.6314613216627), (27, 14.8974475784281), (28, 15.0514219332235), (29, 15.1350449183647), (30, 15.1787472114028), (31, 15.2011050350459), (32, 15.2124152356229), (33, 15.2181037610701), (34, 15.2209564571286), (35, 15.2223849232295), (36, 15.2230996870218), (37, 15.2234572017569), (38, 15.2236359923533), (39, 15.2237253959612), (40, 15.2237700998429)] 